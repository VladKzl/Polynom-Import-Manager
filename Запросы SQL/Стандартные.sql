use RDBMZ_COPY;

--select distinct n.NMK_NAME,cl.NMK_CLASSIF_NAME
--from nmk n
--left join NMK_CLASSIF cl on cl.NMK_CLASSIF_ID=n.NMK_CLASSIF_ID
--left join NMK_CLASSIF_TYPE nc on nc.NMK_CLASSIF_TYPE_ID=n.NMK_CLASSIF_TYPE_ID
--where n.NMK_CLASSIF_TYPE_ID = 17 and n.NMK_NOTUSED<>'T' and upper(n.NMK_CODE) not like 'дсакэ'
--and n.NMK_CLASSIF_ID not IN (13489,25292,25293,25140,25141,19431,24393,24394,25686,19432,25717,22710,22711,25664,25665
--,22656,23402,22657,21149,21150,21377,22877,23230,13490,24820,25121,25100,20426,25687,21132,21134,13491,19422,25064,25066
--,17031,23809,22556,22559,22557,24559,26468,22695,26753,20701,25414,23232,23233,24988,25415,20702,26890,21561,25551,21562
--,17579,21592,17580,17581,24376,23396,23397,25143,25144,25145,25312,25313,25523,25525,17027,18301,18302,21356,17028,23676
--,25034,23677,18303,23253,25280,25281,23398,23399,23505,23506,22604,22605,16978,25550,18093,18094,18096,18097,18095,18098
--,18100,18101,18099,16979,21481,20191,17577,17578,14429,26888,26889,14430,21491,25070,19291,22043,22044,19573,19574,22550
--,22551,23395,23220,20410,20411,19565,19566,25167,21358,23175,25332,21359,25331,20186,20187,21993,13746,13747,21385,21386
--,23228,23229,16283,16284,18487,16964,17282,17283,17284,22024,22025,21378,22950,21379,26324,16965,21037,18585,25533,21038
--,25327,18586,18587,24511,25776,25782,18584,23648,24509,23649,23478,23479,19427,19428,26984,26985,20706,21055,21056,20707
--,22677,24537,22678,15093,23235,20510,15094,20840,21339,21338,18694,18695,20805,20807,20808,20806,20940,21362,22008,22888
--,22889,25328,25329,25339,25340,18720,18721,18837,25543,18838,22717,22718,22719,22891,22892,21498,21499,22558,22248,22249
--,21563,23650,21564,26549,26550,19639,19640,21340,21341,22019,22890,21206,21207,23400,26754,23401,26402,26403,22271,22272
--,19425,19426,21363,21364,21668,21669,19423,23234,23252,26741,21135,19424,23912,23913,22864,22865,13921,18273,24506,13922
--,19429,19430,20406,20407,22606,22607,21995,21996) 

	;  with tree(nm, id,pid, lvl,path1,path2) 
                                  as 
                                    ( 
                                    select cast( nc.NMK_CLASSIF_NAME as varchar(1000)) NMK_CLASSIF_NAME , nc.NMK_CLASSIF_ID,nc.NMK_CLASSIF_PARENT, nc.NMK_CLASSIF_LEVEL,
                                    cast(NMK_CLASSIF_ID as varchar(1000)) NMK_CLASSIF_ID,cast( nc.NMK_CLASSIF_NAME as varchar(1000)) NMK_CLASSIF_NAME
                                    from NMK_CLASSIF nc
                                    where nc.NMK_CLASSIF_ID ='17' 
                                    union all 
                                    select cast(nc.NMK_CLASSIF_NAME  as varchar(1000)) NMK_CLASSIF_NAME, nc.NMK_CLASSIF_ID,nc.NMK_CLASSIF_PARENT, nc.NMK_CLASSIF_LEVEL ,
                                    cast(cast(path1 as varchar(1000))+'/'+cast(id as varchar(1000)) as varchar(1000))
									,   cast(cast(path2 as varchar(1000))+'/'+cast(NMK_CLASSIF_NAME as varchar(1000)) as varchar(1000))
                                   from NMK_CLASSIF nc 
                                    inner join tree on tree.id = nc.NMK_CLASSIF_PARENT
                                    ) 
									    select distinct n.NMK_NAME NAME,i.path2 FOLDER
								 from
								  (
								   select id,pid, nm ,
                                   (case when substring(path1,5,1000)='' then '' else substring(path1,5,1000)+'/' end)+cast(id as varchar(1000)) path1
								   ,(case when substring(path2,1,1000)='' then '' else substring(path2,1,1000)+'/' end)+cast(nm as varchar(1000)) path2
								     from tree 	 group by id,pid, nm,path1,path2
									 ) i
left join NMK n on n.NMK_CLASSIF_ID=i.id
where n.NMK_CLASSIF_TYPE_ID = 17 and n.NMK_NOTUSED<>'T' and upper(n.NMK_CODE) not like 'дсакэ'
and n.NMK_CLASSIF_ID not IN (13489,25292,25293,25140,25141,19431,24393,24394,25686,19432,25717,22710,22711,25664,25665
,22656,23402,22657,21149,21150,21377,22877,23230,13490,24820,25121,25100,20426,25687,21132,21134,13491,19422,25064,25066
,17031,23809,22556,22559,22557,24559,26468,22695,26753,20701,25414,23232,23233,24988,25415,20702,26890,21561,25551,21562
,17579,21592,17580,17581,24376,23396,23397,25143,25144,25145,25312,25313,25523,25525,17027,18301,18302,21356,17028,23676
,25034,23677,18303,23253,25280,25281,23398,23399,23505,23506,22604,22605,16978,25550,18093,18094,18096,18097,18095,18098
,18100,18101,18099,16979,21481,20191,17577,17578,14429,26888,26889,14430,21491,25070,19291,22043,22044,19573,19574,22550
,22551,23395,23220,20410,20411,19565,19566,25167,21358,23175,25332,21359,25331,20186,20187,21993,13746,13747,21385,21386
,23228,23229,16283,16284,18487,16964,17282,17283,17284,22024,22025,21378,22950,21379,26324,16965,21037,18585,25533,21038
,25327,18586,18587,24511,25776,25782,18584,23648,24509,23649,23478,23479,19427,19428,26984,26985,20706,21055,21056,20707
,22677,24537,22678,15093,23235,20510,15094,20840,21339,21338,18694,18695,20805,20807,20808,20806,20940,21362,22008,22888
,22889,25328,25329,25339,25340,18720,18721,18837,25543,18838,22717,22718,22719,22891,22892,21498,21499,22558,22248,22249
,21563,23650,21564,26549,26550,19639,19640,21340,21341,22019,22890,21206,21207,23400,26754,23401,26402,26403,22271,22272
,19425,19426,21363,21364,21668,21669,19423,23234,23252,26741,21135,19424,23912,23913,22864,22865,13921,18273,24506,13922
,19429,19430,20406,20407,22606,22607,21995,21996) 
order by NAME